package remotedesktop.server;

import java.awt.Graphics2D;
import java.awt.Rectangle;
import java.awt.Robot;
import java.awt.Toolkit;
import java.awt.image.BufferedImage;
import java.util.ArrayList;
import java.util.List;

/**
 * Classe respons√°vel por tirar screenshots da tela e chamar um evento para receber as imagens
 * 
 * @author Carlos Rodrigues (carlosrodriguesf96@gmail.com)
 */
public class AutoScreenshot extends Thread {
	
	private Robot robot;
	private Rectangle imageSize;
	private List<AutoScreenshotListener> listeners;
	private float quality;
	
	public AutoScreenshot(Robot robot) {
		this.robot = robot;
		this.imageSize = new Rectangle(Toolkit.getDefaultToolkit().getScreenSize());
		this.listeners = new ArrayList<AutoScreenshotListener>();
		this.quality = (float) 0.8;
	}
	
	/**
	 * Adiciona um listener para ser chamado sempre que uma nova screenshot for obtida
	 * 
	 * @param listener
	 */
	public void addAutoScreenshotListener(AutoScreenshotListener listener) {
		this.listeners.add(listener);
	}
	
	/**
	 * Recebe um image e aplica alguns tratamento para reduzir a qualidade e consequentemente o tamanho
	 * 
	 * @param buffImage
	 * @return BufferedImage
	 */
	private BufferedImage prepare(BufferedImage buffImage) {
		float width = buffImage.getWidth();
		float height = buffImage.getHeight();
		
		float percent = height / width;
		width = width * this.size;
		height = percent * width;
		
		BufferedImage newImage = new BufferedImage((int) width, (int) height, buffImage.getType());
		Graphics2D g2d = newImage.createGraphics();
		g2d.drawImage(buffImage, 0, 0, (int) width, (int) height, null);
		g2d.dispose();
		
		return newImage;
	}
	public void run() {
		while(true) {
			BufferedImage buffImage = prepare(this.robot.createScreenCapture(this.imageSize));
			for(AutoScreenshotListener listener : this.listeners) {
				try {
					listener.onScreenshot(buffImage);
				} catch (Exception ignore) {}
			}
		}
	}
}
