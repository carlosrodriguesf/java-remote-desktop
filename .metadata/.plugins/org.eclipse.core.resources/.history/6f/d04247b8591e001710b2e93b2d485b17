package remotedesktop.server;

import java.awt.AWTException;
import java.awt.Robot;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.ArrayList;
import java.util.List;

import javax.imageio.ImageIO;

public class Server extends Thread implements AutoScreenshotListener, ClientListener {
	private Logger logger;
	private ServerSocket serverSocket;
	private AutoScreenshot screenShooter;
	private List<Client> clients;

	public Server(int port) throws IOException, AWTException {
		this.logger = Logger.getInstance();
		this.serverSocket = new ServerSocket(port);
		this.clients = new ArrayList<Client>();

		this.screenShooter.addAutoScreenshotListener(this);
	}
	
	private void startAutoScreenshot(boolean start) {
		if(start) {
			if(this.screenShooter != null) {
				return;
			}
			
		}
		this.logger.info("Iniciando auto screenshot");
		try {
			this.screenShooter = new AutoScreenshot();
			this.screenShooter.addAutoScreenshotListener(this);
			this.screenShooter.start();
		} catch (AWTException e) {
			this.logger.printStackTrace(e);
			System.exit(1);
		}
		
	}

	private void addNewClient(Socket socket) throws IOException {
		this.logger.info("Novo cliente conectado!");
		
		Client client = new Client(socket, this);
		client.start();
		
		if(this.clients.size() == 0) {
			this.startAutoScreenshot();
		}
		
		this.clients.add(client);
		
		this.logger.info("Cliente configurado: " + client.getClientId());
	}

	@Override
	public void run() {
		while (true) {
			try {
				this.addNewClient(this.serverSocket.accept());
			} catch (Exception e) {
				this.logger.printStackTrace(e);
			}
		}
	}
	
	@Override
	public void onScreenshot(BufferedImage image) {
		ByteArrayOutputStream output = new ByteArrayOutputStream();
		
		try {
			ImageIO.write(image, "gif", output);
		} catch (IOException e) {
			e.printStackTrace();
		}
		
		byte[] bytes = output.toByteArray();
		
		for(Client client : new ArrayList<Client>(this.clients)) {
			client.sendBytes(bytes);
		}
	}

	@Override
	public void onDisconnected(Client client) {
		this.clients.remove(client);
		
		this.logger.info("Cliente desconectado: " + client.getClientId());
		
		if(this.clients.size() == 0) {
			this.logger.info("Interrompendo auto screenshot");
			this.screenShooter.interrupt();
			this.screenShooter = null;
		}
	}
}
